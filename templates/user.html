{% extends "base.html" %}
{% block content %}
<div class="row">
	<div style="display: flex;">
		<div id="userimg"><div class="boximage" style="background-image: url('https://www.gravatar.com/avatar/{{ user.mail|lower|md5}}?s=200');" ></div></div>
		<div>
			<div><h3>{{ user.name }}</h3></div>
			<div>
				<span id="userbalance" data-level="{% if (user.balance < -2000) %}bad{% elif (user.balance < 0) %}negative{% elif (user.balance < 2000) %}positive{% else %}great{% endif %}">{{ user.balance|euro }}</span>
				<button id="userbalanceedit" class="btn btn-default" style="margin-left: 10px;">Edit</button>
				<button id="usertransfere" class="btn btn-default" data-toggle="modal" data-target="#transferemodal">Transfere to user</button>
			</div>
			<script>
				$("#userbalanceedit").click(
					function () {
						var newbalance = parseInt(parseFloat(prompt("New balance:",{{ user.balance }}/100.0))*100);
						jQuery.ajax({
							method: "POST",
							dataType: "text",
							data: { 'newbalance': newbalance },
							url: "{{ url_for('set_balance', name=user.name) }}",
							success: function (data) {
								window.location = "{{ request.url }}"
							}
						});

					}
				);
			</script>
			<div><h4 id="userlog">log:</h4></div>
			<div id="userlogdiv">
				<ul class="list-unstyled">
				{% for i in log %}
					<li class="logentry">
						<a class="btn btn-default" href="{{ url_for('set_balance', name=user.name, newbalance=i.oldbalance) }}"><span class="fa fa-undo"></span> </a>
						{{i.time}} 
						{% if i.methode == "buy" %}
						bought {{ (i.parameter|itemidtoobj).name }} for {{ (i.parameter|itemidtoobj)|itemprice|euro }}
						{% elif i.methode == "recharge" %}
						recharged balance with {{ (i.parameter|itemidtoobj)|itemprice|abs|euro }}
						{% elif i.methode == "set_balance" %}
						set balance from {{ i.oldbalance|euro }} to {{ i.newbalance|euro }}
						{% elif i.methode == "transfereTo" %}
						transfered {{ (i.oldbalance - i.newbalance)|euro }} to <a href="{{ url_for('userpage', id=i.parameter) }}">{{ (i.parameter|useridtoobj).name }}</a>{% if i.reason %}, reason: "{{ i.reason }}"{% endif %}
						{% elif i.methode == "transfereFrom" %}
						<a href="{{ url_for('userpage', id=i.parameter) }}">{{ (i.parameter|useridtoobj).name }}</a> transfered {{ (i.newbalance - i.oldbalance)|euro }}{% if i.reason %}, reason: "{{ i.reason }}"{% endif %}
						{% else %}
						something is broken
						{% endif %}
					</li>
				{% endfor %}
				</ul>
			</div>
		</div>
	</div>
	{% for g in groups %}
	<div class="col-xs-12">
		<div class="panel panel-default">
			<div class="panel-heading">
				<a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion" href="#group_{{g.id}}" aria-expanded="false">
					<h4 class="panel-title">
						{{ g.name }}
					</h4>
				</a>
			</div>
			<div id="group_{{ g.id }}" class="panel-collapse collapse in">
				<div class="panel-body row">
					{% for i in items if i.group_id == g.id %}
					<a href="{{ url_for('buy', name=user.name, itemid=i.id, ref=request.url+'#item_' + i.id|string) }}" id="item_{{i.id}}" class="box col-xs-1 buylink" data-itemid="{{ i.id }}" style="height: 180px;">
							<div class="boximage" style="background-image: url('{{ url_for('get_img', imgid=i.picture_id) }}');"></div>

							<div class="boxspan">
								<span>{{ i.name }}</span>
								<span>{{ i|itemprice|euro }}</span>
							</div>
						</a>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
</div>
<div class="modal fade" id="transferemodal" tabindex="-1" role="dialog">
	<form method="POST" action="{{ url_for('transferemoney') }}">
		<div class="modal-dialog" role="document">
			<div class="modal-content" style="background-color: #222">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Transfere money to user</h4>
				</div>
				<div class="modal-body">
					<input type="hidden" name="sender" value="{{ user.id }}">
					<div class="form-group">
						<label for="username">Recipient</label>
						<input name="recipient" list="users" id="username" type="text" class="form-control">
						<datalist id="users">
							{% for u in users if u.deleted==0 %}
							<option>{{ u.name }}</option>
							{% endfor %}
						</datalist>
					</div>
					<div class="form-group">
						<label for="transfereamount">Amount (€)</label>
						<input name="amount" id="transfereamount" type="number" step="0.01" class="form-control" value="0.00">
					</div>
					<div class="form-group">
						<label for="transferereason">Reason</label>
						<input name="reason" id="transferereason" type="text" class="form-control">
						<small class="form-text text-muted">A reason for the transfere, optional.</small>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="submit" class="btn btn-primary">Transfere</button>
				</div>
			</div>
		</div>
	</form>
</div>


<script>
	var xhr;
	$(".buylink").click(
		function(e) {
			return ; //fix me, need to reload log...
			e.preventDefault();
			jQuery.ajax({
				method: "GET",
				dataType: "text",
				url: this.href,
				data: {'noref': 1},
				success: function (data) {
					//reload balance
					if(xhr && xhr.readyState != 4){
						xhr.abort();
					}
					xhr = jQuery.ajax({
						method: "GET",
						dataType: "text",
						url: "{{ url_for('get_balance', name=user.name)  }}",
						success: function (data) {
							$("#userbalance").text(data/100+"€");
						}
					});


				}
			});
		}
	);
</script>

{% endblock %}
